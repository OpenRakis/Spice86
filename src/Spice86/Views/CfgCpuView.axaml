<UserControl
x:Class="Spice86.Views.CfgCpuView"
xmlns="https://github.com/avaloniaui"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
xmlns:agc="clr-namespace:AvaloniaGraphControl;assembly=AvaloniaGraphControl"
xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
xmlns:viewModels="clr-namespace:Spice86.ViewModels"
xmlns:progRing="clr-namespace:AvaloniaProgressRing;assembly=AvaloniaProgressRing"
xmlns:behaviors="clr-namespace:Spice86.Views.Behaviors"
d:DesignHeight="450"
d:DesignWidth="800"
x:CompileBindings="True"
x:DataType="viewModels:CfgCpuViewModel"
mc:Ignorable="d">
	<Design.DataContext>
		<viewModels:CfgCpuViewModel />
	</Design.DataContext>
	
    <UserControl.Styles>
	    <StyleInclude Source="avares://AvaloniaProgressRing/Styles/ProgressRing.xaml"/>
		
	    <!-- Node boxes styling - static properties only, theme handled by behavior -->
	    <Style Selector="agc|TextSticker">
	        <Setter Property="FontSize" Value="14" />
	        <Setter Property="FontFamily" Value="Cascadia Mono, Consolas, Courier New, monospace" />
	        <Setter Property="Padding" Value="10,6" />
	        <Setter Property="BorderThickness" Value="1.5" />
	        <Setter Property="BorderRadius" Value="4" />
	        <Setter Property="behaviors:TextStickerThemeBehavior.EnableTheming" Value="True" />
	    </Style>
		
	    <Style Selector="agc|Connection">
	    <Setter Property="Brush" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
	    </Style>
		
	    <!-- Edge labels (TextBlock children of GraphPanel) -->
	    <Style Selector="agc|GraphPanel > TextBlock">
	        <Setter Property="FontSize" Value="14" />
	        <Setter Property="Foreground" Value="{Binding (TextElement.Foreground), RelativeSource={RelativeSource Self}}" />
	        <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundAltMediumHighBrush}" />
	        <Setter Property="Padding" Value="4,2" />
	    </Style>
	</UserControl.Styles>
	
	<Grid RowDefinitions="Auto,Auto,*,Auto">
		<!-- Controls panel -->
		<Grid Grid.Row="0" Margin="5" ColumnDefinitions="*,*,*,Auto" DockPanel.Dock="Top">
			<StackPanel Grid.Column="0" Margin="5" Orientation="Horizontal">
				<TextBlock VerticalAlignment="Center">Number of nodes:</TextBlock>
				<TextBlock Padding="5,0,0,0" VerticalAlignment="Center" Text="{Binding NumberOfNodes}" />
			</StackPanel>
			<StackPanel Grid.Column="2" Margin="5" Orientation="Horizontal">
				<TextBlock VerticalAlignment="Center">Max nodes:</TextBlock>
				<NumericUpDown  Margin="5,0,0,0" VerticalAlignment="Center" 
                                Value="{Binding MaxNodesToDisplay}" 
                                FormatString="0" Minimum="0" Maximum="1000" 
                                Width="80" />
			</StackPanel>
			<CheckBox Grid.Column="3" Margin="5" Content="Auto-follow execution" IsChecked="{Binding AutoFollow}" />
		</Grid>
		
		<!-- Search panel with AutoCompleteBox -->
		<Grid IsEnabled="{Binding !IsLoading}" Grid.Row="1" Margin="5" ColumnDefinitions="*,Auto,Auto">
			<StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4">
				<TextBlock VerticalAlignment="Center" Text="Node:" />
				<AutoCompleteBox 
					Width="300"
					ItemsSource="{Binding NodeEntries}"
					SelectedItem="{Binding SelectedNodeEntry}"
					ItemFilter="{Binding NodeFilter}"
					ItemSelector="{Binding NodeItemSelector}"
					Watermark="Type to select a node"
					KeyDown="OnAutoCompleteKeyDown"
					MinimumPrefixLength="1"
					IsTextCompletionEnabled="True">
					<AutoCompleteBox.ItemTemplate>
						<DataTemplate>
							<TextBlock Text="{Binding}" TextWrapping="Wrap" />
						</DataTemplate>
					</AutoCompleteBox.ItemTemplate>
				</AutoCompleteBox>
				<Button 
					Content="Go"
					Command="{Binding NavigateToSelectedNodeCommand}" 
					IsEnabled="{Binding SelectedNodeEntry, Converter={x:Static ObjectConverters.IsNotNull}}" />
			</StackPanel>

			<StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="8,0,0,0">
				<TextBox Width="150" Watermark="Search by text..." Text="{Binding SearchText}" />
				<Button Content="Search" Command="{Binding SearchNodeCommand}" />
			</StackPanel>
			
			<Button Grid.Column="2" Margin="8,0,0,0" Content="Refresh Graph" Command="{Binding UpdateGraphCommand}" />
		</Grid>
		
		<!-- View selection with TabControl -->
		<TabControl Grid.Row="2" SelectedIndex="{Binding SelectedTabIndex}">
            <!-- Graph View Tab -->
            <TabItem Header="Graph View">
                <Grid>
                    <!-- Loading indicator -->
                    <progRing:ProgressRing
                        Width="100"
                        Height="100"
                        IsVisible="{Binding IsLoading}"
                        IsActive="{Binding IsLoading}"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Foreground="{DynamicResource SystemAccentColor}" />
                        
                    <!-- Graph display -->
                    <ScrollViewer IsVisible="{Binding !IsLoading}" HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible">
                        <Border Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
                            <ZoomBorder 
                                Name="ZoomBorder"
                                ToolTip.Tip="Middle click to pan, mouse wheel to zoom/dezoom"
                                Stretch="None"
                                ZoomSpeed="1.5"
                                EnableConstrains="True"
                                ClipToBounds="True" Focusable="True"
                                VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
                                <agc:GraphPanel Graph="{Binding Graph}" LayoutMethod="SugiyamaScheme" />
                            </ZoomBorder>
                        </Border>
                    </ScrollViewer>
                </Grid>
            </TabItem>
            
            <!-- Table View Tab -->
            <TabItem Header="Table View">
                <Grid RowDefinitions="Auto,*">
                    <!-- Table filter -->
                    <Grid Grid.Row="0" Margin="5" ColumnDefinitions="Auto,*">
                        <TextBlock Grid.Column="0" VerticalAlignment="Center" Margin="0,0,5,0">Filter:</TextBlock>
                        <TextBox Grid.Column="1" Text="{Binding TableFilter}" Watermark="Filter nodes by address, type, or assembly..." />
                    </Grid>
                    
                    <!-- Table of nodes -->
                    <DataGrid Grid.Row="1" 
                              ItemsSource="{Binding TableNodes}" 
                              SelectedItem="{Binding SelectedTableNode}"
                              IsReadOnly="True"
                              AutoGenerateColumns="False"
                              GridLinesVisibility="All">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Address" Binding="{Binding Address}" />
                            <DataGridTextColumn Header="Type" Binding="{Binding Type}" />
                            
                            <!-- Predecessors ComboBox -->
                            <DataGridTemplateColumn Header="Predecessors">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding Predecessors}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Address}" ToolTip.Tip="{Binding Assembly}" />
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <!-- Successors ComboBox -->
                            <DataGridTemplateColumn Header="Successors">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox ItemsSource="{Binding Successors}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Address}" ToolTip.Tip="{Binding Assembly}" />
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <DataGridCheckBoxColumn Header="Is the last executed node ?" Binding="{Binding IsLastExecuted}" />
                            <DataGridTextColumn Header="Assembly" Binding="{Binding Assembly}" Width="*"/>
                        </DataGrid.Columns>
                        
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Navigate to Node" 
                                          Command="{Binding NavigateToTableNodeCommand}"
                                          CommandParameter="{Binding SelectedTableNode}"/>
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>
		
		<!-- Status message and legend -->
		<Grid Grid.Row="3" ColumnDefinitions="*,Auto">
			<TextBlock Grid.Column="0" Margin="5" Text="{Binding StatusMessage}" />
			
            <Border Grid.Column="1" 
			Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
			BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
			BorderThickness="1"
			CornerRadius="4" 
			Padding="8,4" 
			Margin="0,5,5,5">
				<StackPanel Orientation="Horizontal" Spacing="8">
					<TextBlock Text="ðŸ”´ Last run" />
					<TextBlock Text="â†’ Jump" />
					<TextBlock Text="âŸ± Call" />
					<TextBlock Text="âŸ° Return" />
					<TextBlock Text="â˜° Selector" />
				</StackPanel>
			</Border>
		</Grid>
	</Grid>
</UserControl>
